name: CI â€” Bandit SAST

on:
  push:
    branches: ['**']
  pull_request:
    branches: ['**']

jobs:
  bandit:
    name: SAST â€” Bandit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install Bandit
        run: |
          python -m pip install --upgrade pip
          pip install bandit

      - name: Run Bandit (recursive)
        run: |
          bandit -r . -f json -o bandit.json || true

      - name: Show detailed Bandit findings
        run: |
          python - <<'PY'
          import json, sys

          try:
              with open("bandit.json") as f:
                  data = json.load(f)
          except Exception as e:
              print("âŒ Impossible de lire bandit.json :", e)
              sys.exit(1)

          results = data.get("results", [])
          if not results:
              print("âœ… Aucune vulnÃ©rabilitÃ© dÃ©tectÃ©e par Bandit.")
              sys.exit(0)

          print(f"ðŸ”Ž {len(results)} vulnÃ©rabilitÃ©(s) dÃ©tectÃ©e(s) :\n")
          severity_order = {"LOW": 1, "MEDIUM": 2, "HIGH": 3}

          results.sort(key=lambda r: severity_order.get(r.get("issue_severity", "LOW").upper(), 0), reverse=True)

          for r in results:
              sev = r.get("issue_severity", "UNKNOWN").upper()
              print(f"[{sev}] {r.get('filename')}:{r.get('line_number')}")
              print(f"  â†³ {r.get('issue_text')}")
              print(f"  (ID: {r.get('test_id')}, Confidence: {r.get('issue_confidence')})\\n")

          if any(r.get("issue_severity", "").upper() in ("MEDIUM", "HIGH") for r in results):
              print(\"â—Ã‰chec : vulnÃ©rabilitÃ©s de sÃ©vÃ©ritÃ© moyenne ou haute dÃ©tectÃ©es.\")
              sys.exit(1)

          print(\"âœ… Seulement des vulnÃ©rabilitÃ©s mineures dÃ©tectÃ©es.\")
          sys.exit(0)
          PY

