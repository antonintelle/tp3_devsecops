name: CI — Bandit SAST

on:
  push:
    branches: ['**']
  pull_request:
    branches: ['**']

jobs:
  bandit:
    name: SAST — Bandit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install Bandit
        run: |
          python -m pip install --upgrade pip
          pip install bandit

      - name: Run Bandit (recursive)
        run: |
          bandit -r . -f json -o bandit.json || true

      - name: Upload Bandit report
        uses: actions/upload-artifact@v4
        with:
          name: bandit-report
          path: bandit.json

      - name: Fail on MEDIUM/HIGH findings
        id: fail-on-findings
        run: |
          python - <<'PY'
          import json,sys
          try:
              doc=json.load(open('bandit.json'))
          except Exception:
              print('No bandit.json found — assuming no findings.')
              sys.exit(0)
          results=doc.get('results', [])
          bad=[r for r in results if r.get('issue_severity','').upper() in ('MEDIUM','HIGH')]
          print(f"Bandit findings total={len(results)}, medium_or_high={len(bad)}")
          if len(bad)>0:
              print('\nThe following medium/high findings were detected:')
              for r in bad:
                  print(f"- {r.get('filename')}:{r.get('line_number')} - {r.get('issue_text')} (severity={r.get('issue_severity')})")
              sys.exit(1)
          sys.exit(0)
          PY
